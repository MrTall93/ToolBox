apiVersion: v1
kind: ConfigMap
metadata:
  name: tool-registry-config
  labels:
    app: tool-registry
data:
  # Application configuration
  app-name: "tool-registry-mcp"
  app-version: "1.0.0"
  log-level: "INFO"
  debug: "false"

  # Database pool configuration
  db-pool-size: "5"
  db-max-overflow: "10"

  # Embedding service configuration
  embedding-endpoint-url: "http://embedding-service:8001/embed"
  embedding-dimension: "1536"

  # Search configuration
  default-similarity-threshold: "0.7"
  default-search-limit: "5"
  use-hybrid-search: "true"

  # CORS configuration
  cors-origins: "*"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: tool-registry-scripts
  labels:
    app: tool-registry
data:
  run_migrations.sh: |
    #!/bin/bash
    set -e

    echo "üîÑ Running database migrations..."

    # Wait for PostgreSQL to be ready
    echo "‚è≥ Waiting for PostgreSQL to be ready..."
    python3 << 'EOF'
    import time
    import sys
    from sqlalchemy import create_engine, text
    from app.config import settings

    max_retries = 30
    retry_interval = 2

    for i in range(max_retries):
        try:
            # Convert async URL to sync URL for this check
            sync_url = settings.DATABASE_URL.replace('+asyncpg', '')
            engine = create_engine(sync_url)
            with engine.connect() as conn:
                conn.execute(text("SELECT 1"))
            print(f"‚úÖ PostgreSQL is ready!")
            sys.exit(0)
        except Exception as e:
            if i < max_retries - 1:
                print(f"‚è≥ PostgreSQL not ready yet (attempt {i+1}/{max_retries}), waiting {retry_interval}s...")
                time.sleep(retry_interval)
            else:
                print(f"‚ùå PostgreSQL failed to become ready after {max_retries} attempts")
                sys.exit(1)
    EOF

    # Run Alembic migrations
    echo "üîÑ Applying Alembic migrations..."
    alembic upgrade head

    echo "‚úÖ Database migrations completed successfully!"
